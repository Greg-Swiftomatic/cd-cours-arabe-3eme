---
import MainLayout from "@layouts/MainLayout.astro";
import QuizRunner from "@components/QuizRunner.astro";
import { getLesson, getQuiz } from "@lib/content";

const cycle = Astro.params.cycle ?? "";
const slug = Astro.params.slug ?? "";

const record = getLesson(cycle, slug);
const quiz = getQuiz(cycle, slug);

if (!record) {
  return Astro.response({
    status: 404,
    body: `Leçon introuvable pour ${cycle}/${slug}`,
  });
}

const lesson = record.lesson;
const pageTitle = `درس: ${lesson.title_ar}`;
const cycleTitles: Record<string, string> = {
  cycle1: "الدورة الأولى",
  cycle2: "الدورة الثانية",
};
---

<MainLayout title={pageTitle} description="درس تفاعلي مع محتوى وامتحان فوري.">
  <div class="relative isolate overflow-hidden px-6 pb-20 pt-12 sm:px-10 lg:px-16">
    <div class="pointer-events-none absolute inset-0 -z-10 opacity-40">
      <div class="absolute left-10 top-16 h-52 w-52 rounded-full bg-primary-500/30 blur-3xl"></div>
      <div class="absolute right-0 top-0 h-72 w-72 rounded-full bg-emerald-500/20 blur-3xl"></div>
    </div>

    <div class="mx-auto flex max-w-5xl flex-col gap-10">
      <div class="flex flex-col gap-6 text-right" dir="rtl">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <a href="/" class="rounded-full border border-white/10 bg-white/10 px-5 py-2 text-sm text-white transition hover:bg-white/20">
            ← العودة إلى المسار
          </a>
          <span class="rounded-full border border-primary-300/20 bg-primary-400/10 px-4 py-2 text-xs text-primary-100/80">
            {cycleTitles[lesson.cycle] ?? lesson.cycle}
          </span>
        </div>
        <h1 class="font-display text-4xl text-white">{lesson.title_ar}</h1>
        <p class="max-w-2xl text-sm leading-7 text-primary-100/70">
          ركّز على النقاط الأساسية، وتدرّب على الأمثلة، ثم حلّ الاختبار في نهاية الدرس لتتبع تقدّمك فورًا.
        </p>
      </div>

      <section class="glass-panel p-8 text-right" dir="rtl">
        <article class="prose max-w-none text-slate-100 prose-headings:font-display prose-headings:text-primary-200 prose-p:leading-7">
          <div set:html={lesson.body_html_ar}></div>
        </article>
      </section>

      <QuizRunner lesson={lesson} quiz={quiz} />
    </div>
  </div>
</MainLayout>
