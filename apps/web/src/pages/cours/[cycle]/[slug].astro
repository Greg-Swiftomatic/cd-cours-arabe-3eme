---
import MainLayout from "@layouts/MainLayout.astro";
import QuizRunner from "@components/QuizRunner.astro";
import { getLesson, getQuiz } from "@lib/content";

const cycle = Astro.params.cycle ?? "";
const slug = Astro.params.slug ?? "";

const record = getLesson(cycle, slug);
const quiz = getQuiz(cycle, slug);

if (!record) {
  return Astro.response({
    status: 404,
    body: `Leçon introuvable pour ${cycle}/${slug}`,
  });
}

const lesson = record.lesson;
const pageTitle = `درس: ${lesson.title_ar}`;
const cycleTitles: Record<string, string> = {
  cycle1: "الدورة الأولى",
  cycle2: "الدورة الثانية",
};
const hasQuiz = Boolean(quiz?.questions?.length);
---

<MainLayout title={pageTitle} description="درس تفاعلي مع محتوى وامتحان فوري.">
  <div class="relative isolate overflow-hidden px-6 pb-20 pt-12 sm:px-10 lg:px-16">
    <div class="pointer-events-none absolute inset-0 -z-10 opacity-20">
      <div class="absolute left-10 top-16 h-72 w-72 rounded-full bg-primary-200 blur-3xl"></div>
      <div class="absolute right-0 top-0 h-80 w-80 rounded-full bg-accent-100 blur-3xl"></div>
    </div>

    <div class="mx-auto flex max-w-5xl flex-col gap-10">
      <div class="flex flex-col gap-6 text-right" dir="rtl">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <a href="/" class="rounded-full border border-gray-300 bg-white px-5 py-2 text-sm font-medium text-gray-700 shadow-sm transition hover:bg-gray-50">
              ← العودة إلى المسار
            </a>
            <a
              href={`/exercices/${lesson.cycle}/${lesson.slug}`}
              class="flex items-center gap-2 rounded-full bg-accent-500 px-5 py-2 text-sm font-semibold text-white shadow-md transition hover:bg-accent-600 hover:scale-105"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              التمارين التفاعلية
            </a>
            {hasQuiz && (
              <a
                href={`/quiz/${lesson.cycle}/${lesson.slug}`}
                class="flex items-center gap-2 rounded-full border border-primary-600 bg-white px-5 py-2 text-sm font-semibold text-primary-700 shadow-md transition hover:border-primary-500 hover:bg-primary-50 hover:scale-105"
              >
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                الانتقال إلى الاختبار
              </a>
            )}
          </div>
          <span class="rounded-full border border-primary-300 bg-primary-50 px-4 py-2 text-xs font-semibold text-primary-700">
            {cycleTitles[lesson.cycle] ?? lesson.cycle}
          </span>
        </div>
        <h1 class="font-display text-4xl text-gray-900">{lesson.title_ar}</h1>
        <p class="max-w-2xl text-base leading-7 text-gray-600">
          ركّز على النقاط الأساسية، وتدرّب على الأمثلة، ثم حلّ الاختبار في نهاية الدرس لتتبع تقدّمك فورًا.
        </p>
      </div>

      <section class="glass-panel p-8 sm:p-10 lg:p-12 text-right" dir="rtl">
        <article class="lesson-content prose prose-lg max-w-none text-gray-900 prose-headings:font-display prose-headings:text-gray-900 prose-p:leading-8 prose-p:text-gray-700 prose-strong:text-gray-900 prose-a:text-primary-600">
          <div set:html={lesson.body_html_ar}></div>
        </article>
      </section>

      <!-- Interactive Exercises Link -->
      <div class="glass-panel p-6 bg-gradient-to-br from-primary-50 to-accent-50">
        <div class="flex items-center justify-between flex-wrap gap-4" dir="rtl">
          <div class="flex items-center gap-4">
            <div class="flex h-14 w-14 items-center justify-center rounded-full bg-primary-600 text-2xl text-white shadow-lg">
              ✍️
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-900">تمارين تفاعلية</h3>
              <p class="text-sm text-gray-600">٧ كتل تدريبية مع تصحيح فوري</p>
            </div>
          </div>
          <a
            href={`/exercices/${lesson.cycle}/${lesson.slug}`}
            class="rounded-full bg-primary-600 px-8 py-3 font-semibold text-white shadow-lg transition hover:bg-primary-700 hover:scale-105"
          >
            ابدأ التمارين ←
          </a>
        </div>
      </div>

      <QuizRunner lesson={lesson} quiz={quiz} />
    </div>
  </div>
</MainLayout>
