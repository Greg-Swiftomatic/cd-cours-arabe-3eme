---
import MainLayout from "@layouts/MainLayout.astro";

type ProgressItem = {
  lessonSlug: string;
  title_fr?: string;
  score: number | null;
  attempts: number;
  updatedAt?: string;
};

interface ProfilePayload {
  email: string;
  name?: string;
  role?: string;
  progress: ProgressItem[];
}

async function loadProfile(requestUrl: string): Promise<ProfilePayload | null> {
  try {
    const apiUrl = new URL("/api/me", requestUrl);
    const response = await fetch(apiUrl.toString());
    if (!response.ok) {
      return null;
    }
    return (await response.json()) as ProfilePayload;
  } catch (error) {
    console.warn("ุชุนุฐุฑ ุฌูุจ ุงูููู ุงูุดุฎุตู", error);
    return null;
  }
}

const profile = await loadProfile(Astro.request.url);
const rawProgress = profile?.progress ?? [];
const ARABIC_DIGITS = ["ู", "ูก", "ูข", "ูฃ", "ูค", "ูฅ", "ูฆ", "ูง", "ูจ", "ูฉ"] as const;

const toArabicDigits = (input: number | string) =>
  input
    .toString()
    .replace(/\d/g, (digit) => ARABIC_DIGITS[Number(digit)]);

const normalizedProgress = rawProgress.map((item) => ({
  lessonTitle: item.title_fr ?? item.lessonSlug,
  attempts: item.attempts ?? 0,
  score: item.score ?? 0,
  updatedAt: item.updatedAt,
}));

const totalAttempts = normalizedProgress.reduce((sum, item) => sum + item.attempts, 0);
const bestScore = normalizedProgress.reduce((max, item) => Math.max(max, item.score), 0);
const completedLessons = normalizedProgress.filter((item) => item.score >= 80).length;

const stats = [
  { label: "ุนุฏุฏ ุงููุญุงููุงุช", value: toArabicDigits(totalAttempts), icon: "๐" },
  { label: "ุฃุนูู ุฏุฑุฌุฉ", value: toArabicDigits(bestScore), icon: "๐" },
  { label: "ุฏุฑูุณ ููุชููุฉ", value: toArabicDigits(completedLessons), icon: "๐" },
];

const hasData = normalizedProgress.length > 0;
const profileName = profile?.name ?? profile?.email ?? "ูุณุชุฎุฏู";
const profileRoleLabel = profile?.role === "guardian" ? "ููู ุฃูุฑ" : "ูุณุชุฎุฏู";

const formatDate = (value?: string) => {
  if (!value) return "โ";
  return new Date(value).toLocaleString("ar-EG");
};

const scoreBadgeClass = (score: number) =>
  score >= 80 ? "bg-emerald-500/30" : "bg-amber-500/30";

const formatScore = (score: number) => toArabicDigits(score);
---

<MainLayout title="ููุญุฉ ุงููุชุงุจุนุฉ ุงูุนุงุฆููุฉ" description="ุฑุงูุจ ุชูุฏู ุงูุฃุจูุงุก ูู ุชุนูู ุงูุนุฑุจูุฉุ ุฏุฑุฌุงุช ุงูุงุฎุชุจุงุฑุงุชุ ูุฃุญุฏุซ ุงูุฃูุดุทุฉ.">
  <div class="relative isolate overflow-hidden px-6 pb-20 pt-12 sm:px-10 lg:px-16">
    <div class="pointer-events-none absolute inset-0 -z-10 opacity-40">
      <div class="absolute left-10 top-10 h-64 w-64 rounded-full bg-primary-500/25 blur-3xl"></div>
      <div class="absolute bottom-0 right-0 h-72 w-72 rounded-full bg-emerald-500/20 blur-3xl"></div>
    </div>

    <div class="mx-auto flex max-w-6xl flex-col gap-10 text-right" dir="rtl">
      <header class="flex flex-col gap-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="space-y-2">
            <h1 class="font-display text-4xl text-white">ููุญุฉ ุงููุชุงุจุนุฉ</h1>
            <p class="text-sm leading-7 text-primary-100/70">
              ูุชุงุจุนุฉ ูุญุธูุฉ ููุณุชูู ุงูุฃุจูุงุก ูู ูู ุฏูุฑุฉุ ูุน ุชูุจููุงุช ุจุงูุฏุฑูุณ ุงูุชู ุชุญุชุงุฌ ุฅูู ูุฑุงุฌุนุฉ ูุชุญุณูู.
            </p>
          </div>
          <a
            href="/"
            class="rounded-full border border-white/10 bg-white/10 px-5 py-2 text-sm text-white transition hover:bg-white/20"
          >
            โ ุงูุนูุฏุฉ ุฅูู ุงูุฏุฑูุณ
          </a>
        </div>

        {profile && (
          <div class="glass-panel flex flex-wrap items-center justify-between gap-4 px-6 py-5 text-sm text-primary-100/80">
            <div class="space-y-1">
              <p>ูุฑุญุจูุง {profileName}</p>
              <p class="text-xs text-primary-100/60">
                ุงูุฏูุฑ ุงูุญุงูู: {profileRoleLabel}
              </p>
            </div>
            <button class="rounded-full border border-primary-200/30 bg-primary-500/20 px-5 py-2 text-xs text-white transition hover:bg-primary-500/30">
              ุชูุฒูู ุชูุฑูุฑ ุงูุฃุณุจูุน
            </button>
          </div>
        )}
        {!profile && (
          <div class="glass-panel px-6 py-5 text-sm text-primary-100/70">
            ูู ุจุชุณุฌูู ุงูุฏุฎูู ููุงุทูุงุน ุนูู ุงูุจูุงูุงุช ุงูุชูุตูููุฉ ุงูุฎุงุตุฉ ุจุนุงุฆูุชู.
          </div>
        )}
      </header>

      <section class="grid gap-4 sm:grid-cols-3">
        {stats.map((stat) => (
          <div class="glass-panel flex flex-col items-center gap-2 px-6 py-6 text-center">
            <span class="text-2xl">{stat.icon}</span>
            <span class="text-3xl font-bold text-white">{stat.value}</span>
            <p class="text-xs text-primary-100/60">{stat.label}</p>
          </div>
        ))}
      </section>

      <section class="glass-panel space-y-4 p-8">
        <header class="flex flex-col gap-2">
          <h2 class="font-display text-2xl text-white">ุชูุฏู ุงูุฏุฑูุณ</h2>
          <p class="text-xs text-primary-100/60">
            ุฑุงูุจ ุงูุฏุฑูุณ ุงูููุชููุฉ ูุงููุชุจููุฉุ ูุชุงุจุน ุขุฎุฑ ุงูุฏุฑุฌุงุช ุงููุญููุฉ ูู ุงูุงุฎุชุจุงุฑุงุช.
          </p>
        </header>

        {hasData && (
          <ul class="space-y-4">
            {normalizedProgress.map((item) => (
              <li class="flex flex-col gap-4 rounded-2xl border border-white/10 bg-white/5 px-5 py-4 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-1 text-right">
                  <p class="text-lg font-semibold text-white">
                    {item.lessonTitle}
                  </p>
                  <p class="text-xs text-primary-100/60">
                    ุขุฎุฑ ุชุญุฏูุซ: {formatDate(item.updatedAt)}
                  </p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs font-semibold text-white">
                  <span class="rounded-full bg-primary-500/20 px-4 py-2">
                    ุงููุญุงููุงุช: {toArabicDigits(item.attempts)}
                  </span>
                  <span class={`rounded-full px-4 py-2 ${scoreBadgeClass(item.score)}`}>
                    ุงูุฏุฑุฌุฉ: {formatScore(item.score)}/ูกูู
                  </span>
                </div>
              </li>
            ))}
          </ul>
        )}

        {!hasData && (
          <div class="rounded-2xl border border-dashed border-white/20 px-6 py-10 text-center text-sm text-primary-100/60">
            ูู ุชูุณุฌู ุฃู ูุญุงููุงุช ุจุนุฏ. ุงุจุฏุฃ ูู ุงูุฏูุฑุฉ ุงูุฃููู ูุฅุธูุงุฑ ุงูุชูุฏู ููุง.
          </div>
        )}
      </section>
    </div>
  </div>
</MainLayout>
